# HablaAI API Reference

> REST API documentation for HablaAI conversational language learning

---

## Overview

HablaAI provides an HTMX-driven API that returns HTML partials for seamless UI updates. The primary endpoint processes chat messages through a LangGraph agent and returns rendered HTML including the AI response, scaffolding assistance (for A0-A1 learners), and grammar feedback.

**Base URL**: `http://localhost:8000`

**Content Type**: All POST requests use `application/x-www-form-urlencoded` (form data).

**Response Format**: HTML partials designed for HTMX integration.

---

## Endpoints

### GET /

Render the main chat interface.

**Response**: Full HTML page with chat UI, level/language selectors, and theme toggle.

**Example**:
```bash
curl http://localhost:8000/
```

---

### POST /chat

Send a message and receive an AI response with optional scaffolding and grammar feedback.

#### Request

**Content-Type**: `application/x-www-form-urlencoded`

| Parameter | Type | Required | Default | Description |
|-----------|------|----------|---------|-------------|
| `message` | string | Yes | - | User's message in the target language |
| `level` | string | No | `A1` | CEFR proficiency level: `A0`, `A1`, `A2`, `B1` |
| `language` | string | No | `es` | Target language code: `es` (Spanish), `de` (German) |

**Example Request**:
```bash
curl -X POST http://localhost:8000/chat \
  -d "message=Hola, me llamo Ana" \
  -d "level=A0" \
  -d "language=es"
```

#### Response

Returns an HTML partial (`partials/message_pair.html`) containing:
- AI response bubble
- Scaffolding section (when `scaffolding.enabled` is `true`)
- Grammar feedback section (when corrections exist)

**Response Context Variables**:

| Variable | Type | Description |
|----------|------|-------------|
| `user_message` | string | Echo of the user's submitted message |
| `ai_response` | string | Generated AI response text |
| `scaffolding` | object | Scaffolding configuration (see below) |
| `grammar_feedback` | array | List of grammar corrections |
| `new_vocabulary` | array | List of vocabulary items introduced |

---

## Data Structures

### ScaffoldingConfig

Scaffolding provides learning assistance for A0-A1 level learners. When enabled, the response includes a collapsible help section with contextual hints, a word bank, and optional sentence starters.

**Activation**: Automatically enabled for `A0` and `A1` levels via LangGraph conditional routing.

| Field | Type | Description |
|-------|------|-------------|
| `enabled` | boolean | Whether scaffolding is active for this response. `true` for A0-A1 levels, `false` otherwise. |
| `word_bank` | array[string] | Relevant vocabulary for forming a response. Format varies by level (see below). |
| `hint_text` | string | English guidance explaining how to respond to the AI's message. |
| `sentence_starter` | string or null | Optional partial sentence to help the learner begin their response. |
| `auto_expand` | boolean | If `true`, scaffolding section displays expanded by default. If `false`, collapsed. |

**Word Bank Format by Level**:

| Level | Format | Example |
|-------|--------|---------|
| A0 | Word with English translation in parentheses | `["hola (hello)", "me llamo (my name is)", "buenos dias (good morning)"]` |
| A1 | Word only (assumes basic vocabulary recognition) | `["hola", "me llamo", "buenos dias"]` |

**Auto-Expand Behavior**:

| Level | `auto_expand` Value | UI Behavior |
|-------|---------------------|-------------|
| A0 | `true` | Scaffolding section is expanded by default to maximize visibility |
| A1 | `false` | Scaffolding section is collapsed by default (click to expand) |

**Example ScaffoldingConfig (A0 level)**:
```json
{
  "enabled": true,
  "word_bank": ["hola (hello)", "me llamo (my name is)", "mucho gusto (nice to meet you)"],
  "hint_text": "Try introducing yourself! Say hello and tell them your name.",
  "sentence_starter": "Hola, me llamo",
  "auto_expand": true
}
```

**Example ScaffoldingConfig (A1 level)**:
```json
{
  "enabled": true,
  "word_bank": ["estoy", "bien", "cansado", "trabajo"],
  "hint_text": "Tell them how you're feeling and why.",
  "sentence_starter": null,
  "auto_expand": false
}
```

**Example ScaffoldingConfig (A2/B1 level - disabled)**:
```json
{
  "enabled": false,
  "word_bank": [],
  "hint_text": "",
  "sentence_starter": null,
  "auto_expand": false
}
```

---

### GrammarFeedback

Grammar corrections are generated by the `analyze` node for the user's last message. Corrections are filtered by level appropriateness.

| Field | Type | Description |
|-------|------|-------------|
| `original` | string | The incorrect phrase from the user's message |
| `correction` | string | The corrected version of the phrase |
| `explanation` | string | Brief, friendly explanation of the error |
| `severity` | string | Error significance: `minor`, `moderate`, or `significant` |

**Severity Levels**:

| Severity | Description | Example |
|----------|-------------|---------|
| `minor` | Small issues that don't impede understanding | Missing accent marks |
| `moderate` | Noticeable errors that may cause confusion | Gender agreement issues |
| `significant` | Errors that change meaning or are grammatically incorrect | Ser vs estar confusion |

**Example GrammarFeedback**:
```json
{
  "original": "Yo soy cansado",
  "correction": "Yo estoy cansado",
  "explanation": "For temporary states like being tired, use 'estar' instead of 'ser'.",
  "severity": "significant"
}
```

---

### VocabWord

Vocabulary items extracted from the conversation to highlight for learning.

| Field | Type | Description |
|-------|------|-------------|
| `word` | string | The word in the target language |
| `translation` | string | English translation |
| `part_of_speech` | string | Grammatical category: `noun`, `verb`, `adjective`, `adverb`, etc. |

**Example VocabWord**:
```json
{
  "word": "cansado",
  "translation": "tired",
  "part_of_speech": "adjective"
}
```

---

## Level-Specific Behavior

The `/chat` endpoint adapts its response based on the learner's CEFR level:

| Level | Scaffolding | AI Language Mix | Grammar Feedback |
|-------|-------------|-----------------|------------------|
| **A0** | Enabled (auto-expanded), translations in word bank | 80% English, 20% Spanish | Basic errors only |
| **A1** | Enabled (collapsed), words only in word bank | 50% English, 50% Spanish | Common errors |
| **A2** | Disabled | 80% Spanish, 20% English | Intermediate errors |
| **B1** | Disabled | 95%+ Spanish | All appropriate errors |

---

## HTML Template Integration

### Response Template Structure

When scaffolding is enabled, the `partials/message_pair.html` template includes the `partials/scaffold.html` partial:

```html
<!-- AI Response -->
<div class="message-enter flex justify-start mb-6">
    <div class="bg-ai rounded-2xl rounded-bl-sm px-4 py-3 max-w-[80%] shadow-sm">
        <div class="text-ai-text leading-relaxed">
            {{ ai_response | safe }}
        </div>
    </div>
</div>

<!-- Scaffolding Help (collapsible) - for A0-A1 learners -->
{% if scaffolding and scaffolding.enabled %}
{% include "partials/scaffold.html" %}
{% endif %}

<!-- Grammar Feedback (collapsible) -->
{% if grammar_feedback %}
{% include "partials/grammar_feedback.html" %}
{% endif %}
```

### Scaffold Partial Features

The scaffold partial (`partials/scaffold.html`) renders:

1. **Toggle Button**: "Need help responding?" with expand/collapse functionality
2. **Hint Section**: Contextual guidance in English
3. **Word Bank**: Clickable vocabulary chips that insert text into the input field
4. **Sentence Starter**: Optional clickable prompt to pre-fill the input

**JavaScript Integration**: Word bank chips trigger `insertWord(word)` and sentence starters trigger `insertStarter(text)` to populate the chat input field.

---

## HTMX Integration

The `/chat` endpoint is designed for HTMX requests. The recommended HTMX attributes:

```html
<form hx-post="/chat"
      hx-target="#chat-container"
      hx-swap="beforeend"
      hx-indicator="#loading">
    <input type="hidden" name="level" value="A0">
    <input type="hidden" name="language" value="es">
    <input type="text" name="message" placeholder="Type your message...">
    <button type="submit">Send</button>
</form>
```

| Attribute | Value | Purpose |
|-----------|-------|---------|
| `hx-post` | `/chat` | POST to chat endpoint |
| `hx-target` | `#chat-container` | Element to update with response |
| `hx-swap` | `beforeend` | Append new messages to container |
| `hx-indicator` | `#loading` | Show loading state during request |

---

## Error Handling

### Common Error Responses

| Status | Cause | Response |
|--------|-------|----------|
| 400 | Missing required `message` parameter | Validation error |
| 422 | Invalid form data | Unprocessable Entity |
| 500 | LangGraph or LLM error | Internal Server Error |

### Validation

The `level` parameter is validated to accept only: `A0`, `A1`, `A2`, `B1`.

The `language` parameter is validated to accept only: `es`, `de`.

---

## Example Workflow

### A0 Beginner Conversation

**Request**:
```bash
curl -X POST http://localhost:8000/chat \
  -d "message=hola" \
  -d "level=A0" \
  -d "language=es"
```

**Response includes**:
- AI response: "Great job! You said 'hola' - that means 'hello'! Now let's learn your name..."
- Scaffolding (expanded by default):
  - Hint: "Try saying your name! Use 'Me llamo' followed by your name."
  - Word bank: `["me llamo (my name is)", "mucho gusto (nice to meet you)"]`
  - Sentence starter: "Me llamo"

### A1 Beginner Conversation

**Request**:
```bash
curl -X POST http://localhost:8000/chat \
  -d "message=Estoy cansado" \
  -d "level=A1" \
  -d "language=es"
```

**Response includes**:
- AI response: "Ah, estas cansado? Yo tambien estoy cansado..."
- Scaffolding (collapsed by default):
  - Hint: "Tell them why you're tired."
  - Word bank: `["trabajo", "mucho", "hoy", "ayer"]`
  - Sentence starter: null

### A2/B1 Conversation

**Request**:
```bash
curl -X POST http://localhost:8000/chat \
  -d "message=Ayer fui al cine con mis amigos" \
  -d "level=A2" \
  -d "language=es"
```

**Response includes**:
- AI response: "Que pelicula vieron? Me encanta ir al cine..."
- Scaffolding: `{ "enabled": false, ... }`
- Grammar feedback (if applicable)

---

## Related Documentation

- [Product Specification](./product.md) - Vision, pedagogy, and feature details
- [Technical Architecture](./architecture.md) - LangGraph design and implementation phases
- [E2E Test Results](./playwright-e2e.md) - Playwright testing documentation
