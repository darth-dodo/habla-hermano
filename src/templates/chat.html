{% extends "base.html" %}

{% block title %}Chat - HablaAI{% endblock %}

{% block content %}
<div class="flex flex-col h-full" x-data="{ level: '{{ current_level or 'A1' }}' }">
    <!-- Header -->
    <header class="flex-shrink-0 bg-gray-800 border-b border-gray-700 px-4 py-3 sm:px-6">
        <div class="max-w-3xl mx-auto flex items-center justify-between">
            <!-- Logo/Brand -->
            <div class="flex items-center gap-2">
                <svg class="w-8 h-8 text-primary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                </svg>
                <h1 class="text-xl font-bold text-white">HablaAI</h1>
            </div>

            <!-- Level Selector -->
            <div class="relative" x-data="{ open: false }">
                <button
                    @click="open = !open"
                    @click.away="open = false"
                    class="flex items-center gap-2 px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm font-medium transition-colors"
                    aria-label="Select language level"
                >
                    <span class="text-primary-400">Level:</span>
                    <span x-text="level" class="text-white"></span>
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>

                <!-- Dropdown Menu -->
                <div
                    x-show="open"
                    x-transition:enter="transition ease-out duration-100"
                    x-transition:enter-start="transform opacity-0 scale-95"
                    x-transition:enter-end="transform opacity-100 scale-100"
                    x-transition:leave="transition ease-in duration-75"
                    x-transition:leave-start="transform opacity-100 scale-100"
                    x-transition:leave-end="transform opacity-0 scale-95"
                    class="absolute right-0 mt-2 w-48 bg-gray-700 rounded-lg shadow-lg border border-gray-600 overflow-hidden z-50"
                >
                    <div class="py-1">
                        {% for lvl, desc in [('A0', 'Complete Beginner'), ('A1', 'Beginner'), ('A2', 'Elementary'), ('B1', 'Intermediate')] %}
                        <button
                            @click="level = '{{ lvl }}'; open = false; $refs.levelInput.value = '{{ lvl }}'"
                            class="w-full px-4 py-2 text-left hover:bg-gray-600 transition-colors"
                            :class="level === '{{ lvl }}' ? 'bg-primary-600/20 text-primary-400' : 'text-gray-200'"
                        >
                            <span class="font-medium">{{ lvl }}</span>
                            <span class="text-gray-400 text-sm ml-2">{{ desc }}</span>
                        </button>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Chat Messages Container -->
    <main class="flex-1 overflow-y-auto" id="chat-container">
        <div class="max-w-3xl mx-auto px-4 py-6 sm:px-6">
            <div id="chat-messages" class="space-y-4">
                <!-- Welcome Message -->
                <div class="message-enter">
                    <div class="flex items-start gap-3">
                        <div class="flex-shrink-0 w-8 h-8 rounded-full bg-primary-600 flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                            </svg>
                        </div>
                        <div class="flex-1 bg-gray-800 rounded-2xl rounded-tl-sm px-4 py-3 max-w-[85%]">
                            <p class="text-gray-100">
                                Hola! I'm your AI Spanish tutor. I'll adapt to your
                                <span class="text-primary-400 font-medium" x-text="level"></span> level.
                            </p>
                            <p class="text-gray-300 mt-2">
                                Try saying something in Spanish, or ask me to help you practice!
                            </p>
                        </div>
                    </div>
                </div>

                {% if messages %}
                    {% for msg in messages %}
                        {% include "partials/message.html" %}
                    {% endfor %}
                {% endif %}
            </div>

            <!-- Loading Indicator (hidden by default) -->
            <div id="loading-indicator" class="hidden mt-4">
                <div class="flex items-start gap-3">
                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-primary-600 flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                        </svg>
                    </div>
                    <div class="bg-gray-800 rounded-2xl rounded-tl-sm px-4 py-3">
                        <div class="loading-dots flex gap-1">
                            <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                            <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                            <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Input Form -->
    <footer class="flex-shrink-0 bg-gray-800 border-t border-gray-700 px-4 py-4 sm:px-6">
        <div class="max-w-3xl mx-auto">
            <form
                id="chat-form"
                hx-post="/chat"
                hx-target="#chat-messages"
                hx-swap="beforeend"
                hx-indicator="#loading-indicator"
                hx-on::before-request="showLoading()"
                hx-on::after-request="hideLoading(); clearInput()"
                class="flex gap-3"
            >
                <!-- Hidden level input -->
                <input type="hidden" name="level" x-ref="levelInput" :value="level">

                <!-- Message Input -->
                <div class="flex-1 relative">
                    <input
                        type="text"
                        name="message"
                        id="message-input"
                        placeholder="Type your message in Spanish or English..."
                        autocomplete="off"
                        required
                        class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-xl text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all"
                    >
                </div>

                <!-- Send Button -->
                <button
                    type="submit"
                    class="flex-shrink-0 px-4 py-3 bg-primary-600 hover:bg-primary-500 active:bg-primary-700 text-white font-medium rounded-xl transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 focus:ring-offset-gray-800 disabled:opacity-50 disabled:cursor-not-allowed"
                    aria-label="Send message"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                    </svg>
                </button>
            </form>

            <!-- Helper Text -->
            <p class="mt-2 text-xs text-gray-500 text-center">
                Press Enter to send. I can help with vocabulary, grammar, and conversation practice.
            </p>
        </div>
    </footer>
</div>
{% endblock %}
